doctype html
html
  head
    title= `${title}`
    meta(name="viewport" content="width=device-width, initial-scale=1")
    link(rel="stylesheet" href="/css/style.css")
  body
    h1 Create / Update Game
    a.btn(href="/") Back to overview

    .form-wrapper
      // Select existing game to update or leave blank to create new
      label(for="existing_game") Existing game (choose to prefill form)
      select#existing_game
        option(value="") -- Create new game --
        each g in games
          option(value=g.id)= g.properties && g.properties.game_name ? g.properties.game_name : g.id

      // mode label (creating or updating)
      p.form-mode(id="form-mode") Creating new game

      form(action="/create-cobj" method="post")
        // store id when updating
        input#existing_id(type="hidden" name="existing_id")

        label(for="game_name") Game Name *
        input#game_name(type="text" name="game_name" required)

        label(for="genre") Genre
        select#genre(name="genre")
          option(value="") -- Select genre --
          each g in genreOptions
            if g.value
              option(value=g.value)= g.label
            else
              option(value=g)= g

        label(for="release_date") Release Date
        input#release_date(type="date" name="release_date")

        label Platform Availability
        .checkbox-group#platform_group
          each p in platformOptions
            - const pid = `platform_${p.value}`
            label.checkbox(for=pid)
              input(type="checkbox" id=pid name="platform_availability" value=p.value)
              |  #{p.label}

        label(for="rating") Rating
        select#rating(name="rating")
          option(value="") -- Select rating --
          each r in ratingOptions
            if r && r.value
              option(value=r.value)= r.label
            else
              option(value=r)= r

        label(for="development_status") Development Status
        select#development_status(name="development_status")
          option(value="") -- Select status --
          each d in devStatusOptions
            if d.value
              option(value=d.value)= d.label
            else
              option(value=d)= d

        label(for="base_price") Base Price
        input#base_price(type="number" step="0.01" name="base_price")

        label(for="global_sales") Global Sales
        input#global_sales(type="number" step="0.01" name="global_sales")

        label(for="lead_developer") Lead Developer
        input#lead_developer(type="text" name="lead_developer")

        label(for="game_engine") Game Engine
        select#game_engine(name="game_engine")
          option(value="") -- Select engine --
          each ge in gameEngineOptions
            if ge && ge.value
              option(value=ge.value)= ge.label
            else
              option(value=ge)= ge

        label(for="store_url") Store URL
        input#store_url(type="url" name="store_url")

        input#submit-btn(type="submit" value="Create")

    // client-side helper to prefill the form when selecting an existing game
    if games && games.length
      script.
        const GAMES = !{JSON.stringify(games)};
        const existingSelect = document.getElementById('existing_game');
        const modeEl = document.getElementById('form-mode');
        const submitBtn = document.getElementById('submit-btn');

        const setField = (id, value) => { const el = document.getElementById(id); if (!el) return; el.value = value || ''; };
        const setSelect = (id, value) => {
          const el = document.getElementById(id);
          if (!el) return;
          if (value == null || value === '') { el.value = ''; return; }
          const valStr = String(value).trim();
          // try case-insensitive match to existing options
          let matched = false;
          for (let i = 0; i < el.options.length; i++) {
            const opt = el.options[i];
            if (opt.value && opt.value.toLowerCase() === valStr.toLowerCase()) {
              el.selectedIndex = i; matched = true; break;
            }
          }
          if (!matched) {
            // fallback: set the raw value (will select if matches or leave blank)
            el.value = value;
          }
        };

        const setModeCreate = () => { if(modeEl) modeEl.textContent = 'Creating new game'; if(submitBtn) submitBtn.value = 'Create'; };
        const setModeUpdate = (name, id) => { if(modeEl) modeEl.textContent = `Updating: ${name || id}`; if(submitBtn) submitBtn.value = 'Update'; };

        const parseMulti = (raw) => {
          if(!raw) return [];
          // split on comma, semicolon or pipe
          return String(raw).split(/[,;|]/).map(s=>s.trim()).filter(Boolean);
        };

        const setCheckboxes = (name, values) => {
          const group = document.getElementsByName(name);
          if(!group || !group.length) return;
          // normalize values to lower-case for matching
          const wanted = (values || []).map(v=>String(v).trim().toLowerCase());
          for (let i=0;i<group.length;i++){
            const cb = group[i];
            cb.checked = wanted.includes(String(cb.value).trim().toLowerCase());
          }
        };

        existingSelect && existingSelect.addEventListener('change', function(e) {
          const id = this.value;
          if(!id) {
            // clear form
            setField('existing_id','');
            setField('game_name','');
            setSelect('genre','');
            setField('release_date','');
            setCheckboxes('platform_availability', []);
            setSelect('rating','');
            setSelect('development_status','');
            setField('base_price','');
            setField('global_sales','');
            setField('lead_developer','');
            setField('game_engine','');
            setField('store_url','');
            setModeCreate();
            return;
          }
          const game = GAMES.find(g=>g.id===id);
          if(!game) return;
          const p = game.properties || {};
          setField('existing_id', game.id);
          setField('game_name', p.game_name || '');
          setSelect('genre', p.genre || '');
          setField('release_date', p.release_date || '');
          setCheckboxes('platform_availability', parseMulti(p.platform_availability || ''));
          setSelect('rating', p.esrb__pegi_rating || '');
          setSelect('development_status', p.development_status || '');
          setField('base_price', p.base_price || '');
          setField('global_sales', p.global_sales__player_count || '');
          setField('lead_developer', p.lead_developer__studio || '');
            setSelect('game_engine', p.game_engine || '');
          setField('store_url', p.store_url || '');
          setModeUpdate(p.game_name || game.id, game.id);
        });
        // If a `selectedId` was passed in the query, select it and trigger prefill
        const SELECTED_ID = !{JSON.stringify(selectedId || '')};
        if(SELECTED_ID && existingSelect) {
          existingSelect.value = SELECTED_ID;
          existingSelect.dispatchEvent(new Event('change'));
        }

        // set initial mode
        if(!SELECTED_ID) setModeCreate();